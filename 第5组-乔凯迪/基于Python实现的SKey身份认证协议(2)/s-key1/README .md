# SKey 身份认证协议的代码实现.



本项目为课程实验内容，简单模拟了通过S/Key协议进行身份认证的过程。

## 运行环境

系统：Arch Linux

语言：Python 3.9

IDE：Pycharm

## 实现的功能

1. S/Key协议身份认证
2. 用户登录日志记录

## 本项目中S/Key协议认证过程

1. 客户端连接服务器，提示用户输入用户名，将输入的用户名发送到服务器
2. 服务器在用户信息字典中查询，根据用户名是否存在向客户端发送不同的反馈信息
3. 客户端收到反馈信息，根据内容判断：
4. 用户名不存在，接受服务器发送的 Seed，与用户名首尾相连后进行一次 MD5 哈希，然后前 8 位与后 8 位进行异或运算，得到 S。对 S 进行 MD5 运算 1 次，得到第 n 个密码；2 次得到第 n-1 个密码；…;n 次得到第 1 个密码。将第一个密码发送到服务器保存在用户信息字典中，依次使用第 2 到 n 个口令进行登录。
5. 用户名存在，但是生成的 n 个口令已使用完，则进行初始化，过程和用户名不存在的情况一样。
6. 用户名存在，且 n 个口令未使用完，则直接提示用户输入口令。
7. 用户输入口令，然后输入验证码（若输入错误，则验证码重新生成，提示用户再次输入，直到输入正确）发送到服务器，服务器接收到客户端发送的口令之后，对其进行一次 MD5 哈希运算，将所得结果与用户信息字典中的上一个口令进行比较，根据是否一致发送不同的反馈信息给客户端。
8. 客户端收到反馈，若两者一致，则允许登录；否则不允许登录。

对于每一次登录，无论是否成功，都需要记录，记录信息包括时间、用户名、登录是否成功。

## 代码实现

首先需要写出保证客户端与服务器通信的代码，该内容代码略，使用端口号为 9999。测试成功后，则同时写客户端和服务器的代码。

对于服务器，开启后将监听 9999 端口，当有客户端连接时，则准备接受用户名。服务器有一个用户信息字典，当收到用户名后，在用户信息字典中查找，若没有该用户，则返回’2’给客户端；若当前用户存在，但生成的口令已经用完，则返回’0’；若当前用户存在，且口令还没有用完，则返回’1’。

而客户端在连接上服务器后，提示用户输入用户名并发送，然后等待服务器的回复，根据服务器回复的内容判断下一步的操作。

如果得知当前用户不存在或者口令已用完，则需要初始化，服务器端发送 seed。客户端收到 seed，与当前用户名连接在一起，进行一次 MD5 运算，得到 32 位的字符串后，将其分为左右两部分，每部分 16 位，进行异或运算，得到 S。之后根据 S/Key 协议原理，生成 n 个口令，并将第一个口令发送给服务器进行保存。服务器收到第一个口令后，将其存储起来，然后等待客户端发送来登录口令。收到后，进行一次 MD5 运算（代码和客户端一样），然后与保存的上一条口令比较，若相同，则说明口令正确，返回 “1”；否则，则说明口令错误，返回 “0”。在客户端发送口令之前，还需要输入验证码。验证码为 4 个数字，输入正确则发送口令给服务器进行验证；否则重新生成验证码，提示用户输入，直到用户输入正确，才允许将口令发送给服务器进行验证，根据服务器的反馈结果确定口令是否正确。

服务器端对于每一次用户尝试登录，无论是否成功，都需要记录日志，日志文件保存在 /path/to/SKeyServer/log.txt 处。记录的内容包括时间、用户名、是否登录成功。

## 结果分析

服务器端正常情况下没有任何输出，只会记录日志文件。

客户端连接上服务器后输入用户名（初始，不存在该用户，进行注册并生成新的口令）：

[![](https://www.writebug.com/myres/static/uploads/2022/4/18/96fd6d44bfb80580294d55be10e48168.writebug)](https://img.litcu.cn/img/202203251244371.png)

手动将生成的口令复制到本地文件中，然后使用第 1 个口令（实际是生成的第二个口令，因为真正的第一个口令已经发送到了服务器端进行保存）登录，登录成功。

[![](https://www.writebug.com/myres/static/uploads/2022/4/18/f517491b5a965f204d9720a1589d95de.writebug)](https://img.litcu.cn/img/202203251244372.png)

然后再次登录，此时仍使用第一个口令，查看结果，发现登录失败。

[![](https://www.writebug.com/myres/static/uploads/2022/4/18/15b1eb0e90f77f0153810c682423b0d4.writebug)](https://img.litcu.cn/img/202203251244373.png)

使用第二个口令尝试，登录成功。

[![](https://www.writebug.com/myres/static/uploads/2022/4/18/5a29280144ca267a107172bc66c8b4cd.writebug)](https://img.litcu.cn/img/202203251244374.png)

当四个口令使用完后，再次尝试登录，重新生成口令。

[![](https://www.writebug.com/myres/static/uploads/2022/4/18/2db5ddc7adf9e1310f428274d822e64d.writebug)](https://img.litcu.cn/img/202203251244375.png)

注册一个新的用户，确保服务器在多个用户存在的前提下仍能正常工作。

[![](https://www.writebug.com/myres/static/uploads/2022/4/18/23578201507e757fb6dbb336d2838d72.writebug)](https://img.litcu.cn/img/202203251244376.png)

对于每一次的用户登录，服务器均会记录日志，对于以上登录过程，记录的日志内容如下图所示。

![](https://www.writebug.com/myres/static/uploads/2022/4/18/5f2b1f90e6ed591ed9e380be42e9db32.writebug)
